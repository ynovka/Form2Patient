<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru"
      th:replace="~{doctor/template :: layout(title=#{doctor.completed.forms.page.title}, content=~{::content})}">
<div th:fragment="content" class="w-full max-w-6xl mx-auto px-0 py-6 flex-1 6xl:box-content">
    <div class="bg-white border border-gray-200 min-h-[60vh] shadow-sm">
        <div class="px-4 sm:px-8 py-6 border-b border-gray-200">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800" th:text="#{doctor.completed.forms.title}">Заполненные формы</h1>
            <p class="text-gray-600 mt-2 text-sm sm:text-base" th:text="#{doctor.completed.forms.subtitle}">Просмотр и управление заполненными анкетами</p>
        </div>

        <div class="px-4 sm:px-8 py-6">
            <div class="bg-gray-50 border border-gray-200 p-4 sm:p-6 mb-6 sm:mb-8">
                <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4" th:text="#{doctor.completed.forms.filters.title}">Фильтры</h2>

                <form id="filtersForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                    <div class="space-y-2">
                        <label for="templateTitle" class="block text-sm font-medium text-gray-700" th:text="#{doctor.completed.forms.filter.by.form}">
                            По форме:
                        </label>
                        <select id="templateTitle" name="templateTitle"
                                class="w-full border-2 border-gray-300 px-3 py-2 sm:py-3 text-sm sm:text-base focus:outline-none focus:border-blue-500 transition-colors duration-200 touch-manipulation">
                            <option value="" th:text="#{doctor.completed.forms.filter.all.forms}">Все формы</option>
                            <option th:each="template : ${uniqueTemplates}"
                                    th:value="${template}"
                                    th:text="${template}">Template Name</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label for="dateFrom" class="block text-sm font-medium text-gray-700" th:text="#{doctor.completed.forms.filter.date.from}">
                            Дата от:
                        </label>
                        <input type="date" id="dateFrom" name="dateFrom"
                               class="w-full border-2 border-gray-300 px-3 py-2 sm:py-3 text-sm sm:text-base focus:outline-none focus:border-blue-500 transition-colors duration-200 touch-manipulation">
                    </div>

                    <div class="space-y-2">
                        <label for="dateTo" class="block text-sm font-medium text-gray-700" th:text="#{doctor.completed.forms.filter.date.to}">
                            Дата до:
                        </label>
                        <input type="date" id="dateTo" name="dateTo"
                               class="w-full border-2 border-gray-300 px-3 py-2 sm:py-3 text-sm sm:text-base focus:outline-none focus:border-blue-500 transition-colors duration-200 touch-manipulation">
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700" th:text="#{doctor.completed.forms.filter.actions}">Действия:</label>
                        <div class="flex flex-col gap-2">
                            <button type="button" id="clearFilters"
                                    class="bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white px-3 py-2 sm:py-3 text-sm font-medium transition-colors duration-200 touch-manipulation"
                                    th:text="#{doctor.completed.forms.filter.reset}">
                                Сбросить
                            </button>
                        </div>
                    </div>
                </form>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <p class="text-sm text-gray-600">
                        <span th:text="#{doctor.completed.forms.results.found}">Найдено:</span> <span id="resultsCount" class="font-medium">-</span> <span th:text="#{doctor.completed.forms.results.forms}">форм</span>
                        <span id="pageInfo" class="ml-4"></span>
                    </p>
                </div>
            </div>

            <div id="loadingState" class="text-center py-12">
                <div class="text-gray-500 text-lg" th:text="#{doctor.completed.forms.loading}">⏳ Загрузка...</div>
            </div>

            <div id="emptyState" class="hidden text-center py-12 sm:py-20">
                <div class="mb-6 sm:mb-8">
                    <svg xmlns="http://www.w3.org/2000/svg" height="60px" viewBox="0 -960 960 960" width="60px" class="mx-auto fill-gray-400 sm:h-20 sm:w-20">
                        <path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h168q13-36 43.5-58t68.5-22q38 0 68.5 22t43.5 58h168q33 0 56.5 23.5T840-760v268q-19-9-39-15.5t-41-9.5v-243H200v560h242q3 22 9.5 42t15.5 38H200Zm0-120v40-560 243-3 280Zm80-40h163q3-21 9.5-41t14.5-39H280v80Zm0-160h244q32-30 71.5-50t84.5-27v-3H280v80Zm0-160h400v-80H280v80Zm200-190q13 0 21.5-8.5T510-820q0-13-8.5-21.5T480-850q-13 0-21.5 8.5T450-820q0 13 8.5 21.5T480-790ZM720-40q-83 0-141.5-58.5T520-240q0-83 58.5-141.5T720-440q83 0 141.5 58.5T920-240q0 83-58.5 141.5T720-40Zm-20-80h40v-100h100v-40H740v-100h-40v100H600v40h100v100Z"/>
                    </svg>
                </div>
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-700 mb-3 sm:mb-4" th:text="#{doctor.completed.forms.empty.title}">Нет заполненных форм</h2>
                <p class="text-gray-500 text-sm sm:text-base" th:text="#{doctor.completed.forms.empty.description}">Заполненные формы не найдены по заданным критериям</p>
            </div>

            <div id="formsList" class="space-y-4 hidden"></div>

            <div id="pagination" class="hidden mt-8 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex gap-2">
                    <button id="prevPage" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 text-sm font-medium transition-colors duration-200 touch-manipulation disabled:opacity-50 disabled:cursor-not-allowed"
                            th:text="#{doctor.completed.forms.pagination.previous}">
                        ← Предыдущая
                    </button>
                    <button id="nextPage" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 text-sm font-medium transition-colors duration-200 touch-manipulation disabled:opacity-50 disabled:cursor-not-allowed"
                            th:text="#{doctor.completed.forms.pagination.next}">
                        Следующая →
                    </button>
                </div>
                <div class="text-sm text-gray-600">
                    <span th:text="#{doctor.completed.forms.pagination.page}">Страница</span> <span id="currentPageDisplay">1</span> <span th:text="#{doctor.completed.forms.pagination.of}">из</span> <span id="totalPagesDisplay">1</span>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        var messages = {
            loadingError: [[#{doctor.completed.forms.js.loading.error}]],
        dataLoadError: [[#{doctor.completed.forms.js.data.load.error}]],
        emptyTitle: [[#{doctor.completed.forms.js.empty.title}]],
        emptyDescription: [[#{doctor.completed.forms.js.empty.description}]],
        completedLabel: [[#{doctor.completed.forms.js.completed.label}]],
        fileLabel: [[#{doctor.completed.forms.js.file.label}]],
        pageInfo: [[#{doctor.completed.forms.js.page.info}]]
        };

        class FormsListManager {
            constructor() {
                this.currentPage = 0;
                this.pageSize = 20;
                this.isLoading = false;

                this.loadingState = document.getElementById('loadingState');
                this.emptyState = document.getElementById('emptyState');
                this.formsList = document.getElementById('formsList');
                this.pagination = document.getElementById('pagination');
                this.resultsCount = document.getElementById('resultsCount');
                this.pageInfo = document.getElementById('pageInfo');

                this.initEventListeners();
                this.loadForms();
            }

            initEventListeners() {
                const filtersForm = document.getElementById('filtersForm');

                let timeout;
                filtersForm.addEventListener('change', () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        this.currentPage = 0;
                        this.loadForms();
                    }, 300);
                });

                document.getElementById('clearFilters').addEventListener('click', () => {
                    filtersForm.reset();
                    this.currentPage = 0;
                    this.loadForms();
                });

                document.getElementById('prevPage').addEventListener('click', () => {
                    if (this.currentPage > 0) {
                        this.currentPage--;
                        this.loadForms();
                    }
                });

                document.getElementById('nextPage').addEventListener('click', () => {
                    this.currentPage++;
                    this.loadForms();
                });

                const dateFrom = document.getElementById('dateFrom');
                const dateTo = document.getElementById('dateTo');

                dateFrom.addEventListener('change', () => {
                    if (dateTo.value && dateFrom.value && new Date(dateFrom.value) > new Date(dateTo.value)) {
                        dateTo.value = dateFrom.value;
                    }
                });

                dateTo.addEventListener('change', () => {
                    if (dateFrom.value && dateTo.value && new Date(dateTo.value) < new Date(dateFrom.value)) {
                        dateFrom.value = dateTo.value;
                    }
                });
            }

            async loadForms() {
                if (this.isLoading) return;

                this.isLoading = true;
                this.showLoading();

                try {
                    const formData = new FormData(document.getElementById('filtersForm'));
                    const params = new URLSearchParams();

                    for (const [key, value] of formData.entries()) {
                        if (value && value.trim()) {
                            params.append(key, value.trim());
                        }
                    }

                    params.append('page', this.currentPage.toString());
                    params.append('size', this.pageSize.toString());

                    console.log('Loading forms with params:', params.toString());

                    const response = await fetch(`/api/doctor/form/completed/search?${params.toString()}`);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Response data:', data);

                    this.renderForms(data);
                } catch (error) {
                    console.error('Error loading forms:', error);
                    this.showError();
                } finally {
                    this.isLoading = false;
                }
            }

            showLoading() {
                this.loadingState.classList.remove('hidden');
                this.emptyState.classList.add('hidden');
                this.formsList.classList.add('hidden');
                this.pagination.classList.add('hidden');
            }

            showError() {
                this.loadingState.classList.add('hidden');
                this.emptyState.classList.remove('hidden');
                this.formsList.classList.add('hidden');
                this.pagination.classList.add('hidden');

                const emptyTitle = this.emptyState.querySelector('h2');
                const emptyText = this.emptyState.querySelector('p');
                emptyTitle.textContent = messages.loadingError;
                emptyText.textContent = messages.dataLoadError;
            }

            renderForms(data) {
                this.loadingState.classList.add('hidden');

                this.resultsCount.textContent = data.totalElements.toString();
                this.pageInfo.textContent = data.totalElements > 0 ?
                    `(${messages.pageInfo} ${data.currentPage + 1} из ${data.totalPages})` : '';

                if (data.content.length === 0) {
                    this.emptyState.classList.remove('hidden');
                    this.formsList.classList.add('hidden');
                    this.pagination.classList.add('hidden');

                    const emptyTitle = this.emptyState.querySelector('h2');
                    const emptyText = this.emptyState.querySelector('p');
                    emptyTitle.textContent = messages.emptyTitle;
                    emptyText.textContent = messages.emptyDescription;
                    return;
                }

                this.formsList.innerHTML = data.content.map(response => {
                    const date = response.formattedDate;

                    return `
                        <div class="bg-white border border-gray-200 p-4 sm:p-6 cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition-colors duration-200 touch-manipulation"
                             onclick="window.location.href='/doctor/form/completed/${response.filename}'">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0 pr-3">
                                    <div class="flex items-start">
                                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-100 border-2 border-green-300 flex items-center justify-center mr-3 sm:mr-4 flex-shrink-0">
                                            <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" class="fill-green-600 sm:w-6 sm:h-6">
                                                <path d="M382-240 154-468l57-57 171 171 367-367 57 57-424 424Z"/>
                                            </svg>
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-2 sm:mb-3 truncate">${response.templateTitle}</h3>
                                            <div class="space-y-1 sm:space-y-2">
                                                <p class="text-xs sm:text-sm text-gray-600">
                                                    <span class="font-medium">${messages.completedLabel}:</span>
                                                    <span class="text-gray-700">${date}</span>
                                                </p>
                                                <p class="text-xs sm:text-sm text-gray-600">
                                                    <span class="font-medium">${messages.fileLabel}:</span>
                                                    <span class="text-gray-700 break-all">${response.filename}</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-shrink-0 self-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#9ca3af" class="transform group-hover:translate-x-1 transition-transform duration-200 sm:h-6 sm:w-6">
                                        <path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                this.emptyState.classList.add('hidden');
                this.formsList.classList.remove('hidden');

                if (data.totalPages > 1) {
                    this.updatePagination(data);
                    this.pagination.classList.remove('hidden');
                } else {
                    this.pagination.classList.add('hidden');
                }
            }

            updatePagination(data) {
                const prevBtn = document.getElementById('prevPage');
                const nextBtn = document.getElementById('nextPage');
                const currentPageDisplay = document.getElementById('currentPageDisplay');
                const totalPagesDisplay = document.getElementById('totalPagesDisplay');

                prevBtn.disabled = !data.hasPrevious;
                nextBtn.disabled = !data.hasNext;
                currentPageDisplay.textContent = (data.currentPage + 1).toString();
                totalPagesDisplay.textContent = data.totalPages.toString();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new FormsListManager();
        });
    </script>
</div>
</html>